<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามนกอัจฉริยะ | AI Bird Tracking System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        kanit: ['Kanit', 'sans-serif'],
                        inter: ['Inter', 'sans-serif']
                    },
                    colors: {
                        'primary': '#2196F3',
                        'secondary': '#1976D2',
                        'accent': '#FFC107',
                        'background': '#F5F7FA',
                        'card': '#FFFFFF',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .kanit-font { font-family: 'Kanit', sans-serif; }
        .inter-font { font-family: 'Inter', sans-serif; }
        .video-container { position: relative; width: 100%; padding-top: 56.25%; }
        .video-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .alert-container::-webkit-scrollbar { width: 8px; }
        .alert-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>

<body class="bg-background kanit-font">

    <div class="fixed top-4 right-4 z-50">
        <button id="lang-toggle-btn"
            class="px-4 py-2 bg-primary text-white rounded-full shadow-lg hover:bg-secondary transition-colors duration-300">
            EN | ไทย
        </button>
    </div>

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8 bg-card p-6 rounded-3xl shadow-xl border-t-4 border-primary">
            <div class="flex items-center justify-center space-x-4">
                <i class="fa-solid fa-dove text-4xl text-primary animate-pulse"></i>
                <h1 class="text-4xl md:text-5xl font-bold text-primary lang-th">ระบบเฝ้าดูบ้านนกนางแอ่น</h1>
                <h1 class="text-4xl md:text-5xl font-bold text-primary lang-en hidden">Swallow Nest Monitoring System</h1>
            </div>
            <p class="text-lg text-slate-600 mt-2 lang-th">ตรวจจับการเข้า-ออกของนกนางแอ่นแบบเรียลไทม์</p>
            <p class="text-lg text-slate-600 mt-2 lang-en hidden">Real-time Swallow In/Out Detection</p>
            <span
                class="inline-block mt-4 px-4 py-1 bg-green-500 text-white rounded-full text-sm font-medium lang-th">AI
                กำลังทำงาน</span>
            <span
                class="inline-block mt-4 px-4 py-1 bg-green-500 text-white rounded-full text-sm font-medium lang-en hidden">AI
                Active</span>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <section class="lg:col-span-2 space-y-8">
                <div class="bg-card p-6 rounded-3xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-secondary mb-4 lang-th">วิดีโอเฝ้าดูบ้านนกนางแอ่น</h2>
                    <h2 class="text-2xl font-semibold text-secondary mb-4 lang-en hidden">Swallow Nest Live Feed</h2>
                    <div class="video-container rounded-2xl overflow-hidden shadow-inner bg-slate-100">
                        <img class="video-feed"
                            src="{{ url_for('video_feed') }}"
                            alt="Swallow Nest Monitoring"
                            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM2MCIgdmlld0JveD0iMCAwIDY0MCAzNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI2NDAiIGhlaWdodD0iMzYwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjMyMCIgeT0iMTgwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjM3MzgxIiBmb250LWZhbWlseT0iS2FuaXQsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTgiPuC4geC4peC5ieC4reC4h+C5hOC4oeC5iOC4reC4suC4geC4suC4o+C4l+C4s+C4h+C4suC4mzwvdGV4dD4KPHN2ZyB4PSIyODAiIHk9IjEyMCIgd2lkdGg9IjgwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiM2MzczODEiPgo8cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptLTIgMTVsLTUtNSAxLjQxLTEuNDFMMTAgMTQuMTdsNy41OS03LjU5TDE5IDhsLTkgOXoiLz4KPHN2Zz4KPC9zdmc+'">
                        <div class="absolute inset-0 flex items-center justify-center bg-slate-100" style="display: none;">
                            <div class="text-center">
                                <i class="fa-solid fa-video-slash text-4xl text-slate-400 mb-2"></i>
                                <p class="text-slate-500 lang-th">กล้องไม่พร้อมใช้งาน</p>
                                <p class="text-slate-500 lang-en hidden">Camera not available</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-card p-6 rounded-3xl shadow-lg border-l-4 border-green-500">
                        <h3 class="text-lg font-medium text-slate-500 lang-th">นกนางแอ่นบินเข้า</h3>
                        <h3 class="text-lg font-medium text-slate-500 lang-en hidden">Swallows In</h3>
                        <div id="birds-in" class="text-5xl font-bold text-green-600 mt-2">0</div>
                        <p class="text-sm text-slate-400 mt-1 lang-th">วันนี้</p>
                        <p class="text-sm text-slate-400 mt-1 lang-en hidden">Today</p>
                    </div>
                    <div class="bg-card p-6 rounded-3xl shadow-lg border-l-4 border-red-500">
                        <h3 class="text-lg font-medium text-slate-500 lang-th">นกนางแอ่นบินออก</h3>
                        <h3 class="text-lg font-medium text-slate-500 lang-en hidden">Swallows Out</h3>
                        <div id="birds-out" class="text-5xl font-bold text-red-600 mt-2">0</div>
                        <p class="text-sm text-slate-400 mt-1 lang-th">วันนี้</p>
                        <p class="text-sm text-slate-400 mt-1 lang-en hidden">Today</p>
                    </div>
                    <div class="bg-card p-6 rounded-3xl shadow-lg border-l-4 border-primary">
                        <h3 class="text-lg font-medium text-slate-500 lang-th">คงเหลือในรัง</h3>
                        <h3 class="text-lg font-medium text-slate-500 lang-en hidden">In Nest Now</h3>
                        <div id="total-birds" class="text-5xl font-bold text-primary mt-2">0</div>
                        <p class="text-sm text-slate-400 mt-1 lang-th">ตัว</p>
                        <p class="text-sm text-slate-400 mt-1 lang-en hidden">birds</p>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-1 space-y-8">
                <div class="bg-card p-6 rounded-3xl shadow-lg border-r-4 border-red-500 relative">
                    <h2 class="text-2xl font-semibold text-red-500 mb-4 lang-th">การตรวจจับสิ่งแปลกปลอม</h2>
                    <h2 class="text-2xl font-semibold text-red-500 mb-4 lang-en hidden">Anomaly Detection</h2>
                    <div id="anomaly-alerts" class="space-y-4 max-h-96 overflow-y-auto alert-container">
                    </div>
                    <div id="no-anomalies-th" class="text-center text-slate-400 mt-4">ยังไม่พบสิ่งแปลกปลอมในขณะนี้</div>
                    <div id="no-anomalies-en" class="text-center text-slate-400 mt-4 hidden">No anomalies detected yet.</div>
                </div>

                <div class="bg-card p-6 rounded-3xl shadow-lg border-l-4 border-accent">
                    <h2 class="text-2xl font-semibold text-accent mb-4 lang-th">AI Insights</h2>
                    <h2 class="text-2xl font-semibold text-accent mb-4 lang-en hidden">AI Insights</h2>
                    <div id="ai-insights" class="space-y-2">
                    </div>
                    <div id="no-insights-th" class="text-center text-slate-400 mt-4">ยังไม่มีข้อมูลเชิงลึกจาก AI</div>
                    <div id="no-insights-en" class="text-center text-slate-400 mt-4 hidden">No AI insights available yet.</div>
                </div>
            </section>

        </main>

        <section class="mt-8 bg-card p-6 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold text-secondary mb-4 lang-th">การวิเคราะห์สถิติและการคาดการณ์</h2>
            <h2 class="text-2xl font-semibold text-secondary mb-4 lang-en hidden">Statistical Analysis & Prediction</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                <div>
                    <h3 class="text-xl font-medium text-slate-600 mb-2 lang-th">แนวโน้มจำนวนนก</h3>
                    <h3 class="text-xl font-medium text-slate-600 mb-2 lang-en hidden">Bird Count Trend</h3>
                    <div class="h-80">
                        <canvas id="birdTrendChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-medium text-slate-600 mb-2 lang-th">พฤติกรรมและการคาดการณ์</h3>
                    <h3 class="text-xl font-medium text-slate-600 mb-2 lang-en hidden">Behavior & Prediction</h3>
                    <div class="h-80">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Chatbot Section -->
        <section class="mt-8 bg-card p-6 rounded-3xl shadow-xl border-t-4 border-primary">
            <div class="flex items-center space-x-3 mb-4">
                <i class="fa-solid fa-robot text-2xl text-primary"></i>
                <h2 class="text-2xl font-semibold text-primary lang-th">🧠 Smart AI Assistant</h2>
                <h2 class="text-2xl font-semibold text-primary lang-en hidden">🧠 Smart AI Assistant</h2>
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium lang-th">ฟรี 100%</span>
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium lang-en hidden">100% Free</span>
            </div>
            
            <!-- Chat Messages Container -->
            <div id="chat-messages" class="h-96 overflow-y-auto bg-slate-50 rounded-2xl p-4 mb-4 space-y-3">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm max-w-md">
                        <p class="text-gray-800 lang-th">สวัสดีครับ! ผมสามารถช่วยคุณได้ในเรื่อง:</p>
                        <p class="text-gray-800 lang-en hidden">Hello! I can help you with:</p>
                        <ul class="text-sm text-gray-600 mt-2 space-y-1">
                            <li class="lang-th">📊 สถิติการบินของนก (เข้า, ออก, บินวน)</li>
                            <li class="lang-en hidden">📊 Bird flight statistics (in, out, circling)</li>
                            <li class="lang-th">🚨 ข้อมูลสิ่งแปลกปลอม</li>
                            <li class="lang-en hidden">🚨 Anomaly data</li>
                            <li class="lang-th">📈 สรุปรายงานประจำวัน/สัปดาห์/เดือน</li>
                            <li class="lang-en hidden">📈 Daily/weekly/monthly reports</li>
                        </ul>
                        <p class="text-xs text-gray-500 mt-2 lang-th">ลองถามเช่น: "เดือนที่แล้วมีนกกี่ตัว?" หรือ "สรุปข้อมูลวันนี้"</p>
                        <p class="text-xs text-gray-500 mt-2 lang-en hidden">Try asking: "How many birds last month?" or "Summarize today's data"</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="flex space-x-3">
                <input type="text" id="chat-input" 
                       placeholder="พิมพ์คำถามของคุณ... (เช่น เดือนที่แล้วมีนกกี่ตัว?)" 
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                       onkeypress="handleChatKeyPress(event)">
                <button id="send-chat-btn" onclick="sendChatMessage()" 
                        class="px-6 py-3 bg-primary text-white rounded-2xl hover:bg-secondary transition-colors duration-200 flex items-center space-x-2">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span class="lang-th">ส่ง</span>
                    <span class="lang-en hidden">Send</span>
                </button>
            </div>
        </section>

        <div id="last-updated" class="text-right text-slate-500 text-sm mt-8"></div>
    </div>

    <div id="anomaly-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4">
        <div class="bg-card p-8 rounded-3xl shadow-2xl max-w-lg w-full relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 text-3xl">
                &times;
            </button>
            <h3 id="modal-title" class="text-2xl font-bold text-secondary mb-4"></h3>
            <img id="modal-image" class="w-full h-auto rounded-xl mb-4" src="" alt="Anomaly detail">
            <div id="modal-details" class="space-y-2 text-slate-700"></div>
        </div>
    </div>


    <script>
        let currentLang = 'th';
        let birdTrendChart, predictionChart;
        let cachedAnomalies = [];
        let userClickedLanguageToggle = false; // เพิ่มตัวแปรป้องกันการเปลี่ยนภาษาอัตโนมัติ

        function toggleLanguage() {
            try {
                const langTh = document.querySelectorAll('.lang-th');
                const langEn = document.querySelectorAll('.lang-en');
                const button = document.getElementById('lang-toggle-btn');
                const chatInput = document.getElementById('chat-input');
                const isThVisible = langTh[0] && !langTh[0].classList.contains('hidden');
                
                if (isThVisible) {
                    langTh.forEach(el => el.classList.add('hidden'));
                    langEn.forEach(el => el.classList.remove('hidden'));
                    button.textContent = 'ไทย | EN';
                    chatInput.placeholder = 'Type your question... (e.g. How many birds last month?)';
                    currentLang = 'en';
                } else {
                    langEn.forEach(el => el.classList.add('hidden'));
                    langTh.forEach(el => el.classList.remove('hidden'));
                    button.textContent = 'EN | ไทย';
                    chatInput.placeholder = 'พิมพ์คำถามของคุณ... (เช่น เดือนที่แล้วมีนกกี่ตัว?)';
                    currentLang = 'th';
                }

                const noAnomaliesTh = document.getElementById('no-anomalies-th');
                const noAnomaliesEn = document.getElementById('no-anomalies-en');
                const noInsightsTh = document.getElementById('no-insights-th');
                const noInsightsEn = document.getElementById('no-insights-en');
                
                if (noAnomaliesTh) noAnomaliesTh.classList.toggle('hidden', currentLang === 'en');
                if (noAnomaliesEn) noAnomaliesEn.classList.toggle('hidden', currentLang === 'th');
                if (noInsightsTh) noInsightsTh.classList.toggle('hidden', currentLang === 'en');
                if (noInsightsEn) noInsightsEn.classList.toggle('hidden', currentLang === 'th');
                
                if (birdTrendChart) {
                    birdTrendChart.data.datasets[0].label = currentLang === 'th' ? 'จำนวนนกคงเหลือ' : 'Birds in Nest';
                    birdTrendChart.update();
                }
                if (predictionChart) {
                    predictionChart.data.datasets[0].label = currentLang === 'th' ? 'นกบินเข้า' : 'Birds In';
                    predictionChart.data.datasets[1].label = currentLang === 'th' ? 'นกบินออก' : 'Birds Out';
                    predictionChart.update();
                }
                updateLastUpdated();
            } catch (error) {
                console.error("Error toggling language:", error);
            }
        }

        async function updateDataFromAPI() {
            try {
                // ใช้ข้อมูลจริงจาก API statistics
                const statsResponse = await fetch('/api/statistics');
                const statsData = await statsResponse.json();

                // อัปเดตข้อมูลจริงจากฐานข้อมูล
                document.getElementById('birds-in').textContent = statsData.total_birds_entering || 0;
                document.getElementById('birds-out').textContent = statsData.total_birds_exiting || 0;
                document.getElementById('total-birds').textContent = statsData.net_change || 0;

                const lastUpdatedText = currentLang === 'th' ? `อัปเดตล่าสุด: ${new Date().toLocaleString('th-TH')}` : `Last updated: ${new Date().toLocaleString('en-US')}`;
                document.getElementById('last-updated').textContent = lastUpdatedText;
                
                updateTrendChart(statsData.net_change || 0);
                
                // อัปเดตข้อมูลสิ่งแปลกปลอมจริง
                const anomaliesResponse = await fetch('/api/anomalies');
                if (anomaliesResponse.ok) {
                    cachedAnomalies = await anomaliesResponse.json();
                    displayAnomalyAlerts(cachedAnomalies);
                }

                // อัปเดตข้อมูลการวิเคราะห์
                const analysisResponse = await fetch('/api/analysis');
                if (analysisResponse.ok) {
                    const analysisData = await analysisResponse.json();
                    updateChartsWithAnalysisData(analysisData);
                }

                // อัปเดต AI insights
                const insightsResponse = await fetch('/api/insights');
                if (insightsResponse.ok) {
                    const insightsData = await insightsResponse.json();
                    displayAiInsights(insightsData);
                }
                
            } catch (error) {
                console.error("Error fetching data from API:", error);
                // ใช้ข้อมูลสำรองถ้า API ไม่ตอบสนอง
                document.getElementById('birds-in').textContent = '0';
                document.getElementById('birds-out').textContent = '0';
                document.getElementById('total-birds').textContent = '0';
            }
        }

        // Chat Functions
        async function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            const sendBtn = document.getElementById('send-chat-btn');
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            // แสดงข้อความของผู้ใช้
            addChatMessage(message, 'user');
            chatInput.value = '';
            
            // แสดงสถานะกำลังพิมพ์
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span class="lang-th">กำลังคิด...</span><span class="lang-en hidden">Thinking...</span>';
            
            try {
                // ส่งไปยัง API chatbot
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: message })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addChatMessage(data.response, 'bot');
                } else {
                    throw new Error('API Error');
                }
            } catch (error) {
                console.error('Chat error:', error);
                const errorMsg = currentLang === 'th' ? 
                    'ขออภัย เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองอีกครั้ง' : 
                    'Sorry, connection error. Please try again.';
                addChatMessage(errorMsg, 'bot');
            }
            
            // รีเซ็ตปุ่ม
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> <span class="lang-th">ส่ง</span><span class="lang-en hidden">Send</span>';
        }

        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'flex items-start space-x-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-primary text-white p-3 rounded-2xl rounded-tr-none shadow-sm max-w-md">
                        <p>${message}</p>
                    </div>
                    <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-user text-gray-600 text-sm"></i>
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-start space-x-3';
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm max-w-md">
                        <p class="text-gray-800">${message}</p>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function updateLastUpdated() {
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                const now = new Date();
                const lastUpdatedText = currentLang === 'th' ? 
                    `อัปเดตล่าสุด: ${now.toLocaleString('th-TH')}` : 
                    `Last updated: ${now.toLocaleString('en-US')}`;
                lastUpdatedElement.textContent = lastUpdatedText;
            }
        }

        function displayAnomalyAlerts(anomalies) {
            const anomalyContainer = document.getElementById('anomaly-alerts');
            const noAnomaliesTh = document.getElementById('no-anomalies-th');
            const noAnomaliesEn = document.getElementById('no-anomalies-en');
            
            if (anomalies && anomalies.length > 0) {
                if (noAnomaliesTh) noAnomaliesTh.classList.add('hidden');
                if (noAnomaliesEn) noAnomaliesEn.classList.add('hidden');
                anomalyContainer.innerHTML = '';
                anomalies.forEach(anomaly => {
                    const date = new Date(anomaly.timestamp * 1000);
                    const alertHtml = `
                        <div class="flex items-center gap-4 p-4 bg-red-50 rounded-2xl shadow">
                            <i class="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i>
                            <div>
                                <h4 class="font-semibold text-red-700 lang-th">สิ่งแปลกปลอม: ${anomaly.object_type}</h4>
                                <h4 class="font-semibold text-red-700 lang-en hidden">Anomaly: ${anomaly.object_type}</h4>
                                <p class="text-sm text-gray-500 lang-th">เวลา: ${date.toLocaleString('th-TH')}</p>
                                <p class="text-sm text-gray-500 lang-en hidden">Time: ${date.toLocaleString('en-US')}</p>
                            </div>
                            <button onclick="showAnomalyDetails(${anomaly.timestamp})"
                                class="ml-auto px-3 py-1 text-sm bg-red-200 text-red-800 rounded-full hover:bg-red-300 lang-th">
                                รายละเอียด
                            </button>
                            <button onclick="showAnomalyDetails(${anomaly.timestamp})"
                                class="ml-auto px-3 py-1 text-sm bg-red-200 text-red-800 rounded-full hover:bg-red-300 lang-en hidden">
                                Details
                            </button>
                        </div>
                    `;
                    anomalyContainer.innerHTML += alertHtml;
                });
                // ลบ toggleLanguage() ออกเพื่อป้องกันการกระพริบ
            } else {
                if (noAnomaliesTh) noAnomaliesTh.classList.remove('hidden');
                if (noAnomaliesEn) noAnomaliesEn.classList.add('hidden');
                anomalyContainer.innerHTML = '';
                // ลบ toggleLanguage() ออกเพื่อป้องกันการกระพริบ
            }
        }

        function displayAiInsights(insights) {
            const insightsContainer = document.getElementById('ai-insights');
            const noInsightsTh = document.getElementById('no-insights-th');
            const noInsightsEn = document.getElementById('no-insights-en');
            
            if (insights && insights.length > 0) {
                if (noInsightsTh) noInsightsTh.classList.add('hidden');
                if (noInsightsEn) noInsightsEn.classList.add('hidden');
                insightsContainer.innerHTML = '';
                insights.forEach(insight => {
                    const insightHtml = `<p class="text-gray-700 lang-th">• ${insight.text_th}</p>
                                         <p class="text-gray-700 lang-en hidden">• ${insight.text_en}</p>`;
                    insightsContainer.innerHTML += insightHtml;
                });
                // ลบ toggleLanguage() ออกเพื่อป้องกันการกระพริบ
            } else {
                if (noInsightsTh) noInsightsTh.classList.remove('hidden');
                if (noInsightsEn) noInsightsEn.classList.add('hidden');
                insightsContainer.innerHTML = '';
                // ลบ toggleLanguage() ออกเพื่อป้องกันการกระพริบ
            }
        }
        
        function showAnomalyDetails(timestamp) {
            const anomaly = cachedAnomalies.find(a => a.timestamp === timestamp);
            if (anomaly) {
                const modal = document.getElementById('anomaly-modal');
                document.getElementById('modal-title').textContent = currentLang === 'th' ? `รายละเอียดสิ่งแปลกปลอม: ${anomaly.object_type}` : `Anomaly Details: ${anomaly.object_type}`;
                document.getElementById('modal-image').src = `static/anomalies/${anomaly.image_path}`;
                const date = new Date(anomaly.timestamp * 1000);
                const detailsHtml = `
                    <p class="lang-th"><strong>เวลา:</strong> ${date.toLocaleString('th-TH')}</p>
                    <p class="lang-en hidden"><strong>Time:</strong> ${date.toLocaleString('en-US')}</p>
                    <p class="lang-th"><strong>ประเภท:</strong> ${anomaly.object_type}</p>
                    <p class="lang-en hidden"><strong>Type:</strong> ${anomaly.object_type}</p>
                `;
                document.getElementById('modal-details').innerHTML = detailsHtml;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                // ลบ toggleLanguage() ออกเพื่อป้องกันการกระพริบ - ให้ใช้ภาษาปัจจุบัน
            }
        }

        function closeModal() {
            document.getElementById('anomaly-modal').classList.add('hidden');
            document.getElementById('anomaly-modal').classList.remove('flex');
        }

        function initializeTrendChart() {
            const ctx = document.getElementById('birdTrendChart').getContext('2d');
            birdTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: currentLang === 'th' ? 'จำนวนนกคงเหลือ' : 'Birds in Nest',
                        data: [],
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.2)',
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                        }
                    }
                }
            });
        }

        function updateTrendChart(newTotal) {
            const now = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            if (birdTrendChart.data.labels.length >= 20) {
                birdTrendChart.data.labels.shift();
                birdTrendChart.data.datasets[0].data.shift();
            }
            birdTrendChart.data.labels.push(now);
            birdTrendChart.data.datasets[0].data.push(newTotal);
            birdTrendChart.update();
        }

        function initializePredictionChart() {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            predictionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: currentLang === 'th' ? 'นกบินเข้า' : 'Birds In',
                        data: [],
                        backgroundColor: 'rgba(33, 150, 243, 0.7)',
                        borderColor: '#2196F3',
                        borderWidth: 1,
                    }, {
                        label: currentLang === 'th' ? 'นกบินออก' : 'Birds Out',
                        data: [],
                        backgroundColor: 'rgba(255, 193, 7, 0.7)',
                        borderColor: '#FFC107',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        }
        
        function updateChartsWithAnalysisData(data) {
            if (predictionChart && data && data.length > 0) {
                const labels = data.map(item => item.date);
                const birdsIn = data.map(item => item.total_in);
                const birdsOut = data.map(item => item.total_out);

                predictionChart.data.labels = labels;
                predictionChart.data.datasets[0].data = birdsIn;
                predictionChart.data.datasets[1].data = birdsOut;
                predictionChart.update();
            }
        }

        window.onload = function () {
            document.getElementById('lang-toggle-btn').addEventListener('click', toggleLanguage);
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('anomaly-modal').addEventListener('click', (e) => {
                if (e.target.id === 'anomaly-modal') {
                    closeModal();
                }
            });
            
            initializeTrendChart();
            initializePredictionChart();
            
            // ลดความถี่การอัปเดตจาก 1000ms เป็น 3000ms เพื่อลดการกระพริบ
            setInterval(updateDataFromAPI, 3000);
            
            updateDataFromAPI();
        };

    </script>

</body>
</html>