<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Anomaly Alert Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.2em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .alerts-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
        }

        .alerts-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .alerts-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        .alert-item:hover {
            background-color: #f8f9fa;
        }

        .alert-item.unread {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }

        .alert-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alert-type {
            font-size: 1.3em;
            font-weight: bold;
            margin-right: 15px;
        }

        .alert-time {
            color: #666;
            font-size: 0.9em;
        }

        .alert-confidence {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: auto;
        }

        .alert-message {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }

        .alert-details {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-refresh {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .no-alerts {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 1.2em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
            color: #666;
        }

        .animal-emoji {
            font-size: 2em;
            margin-right: 10px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .alert-item.unread {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°</h1>
            <p>Smart Swallow Nest Anomaly Detection System</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-alerts" style="color: #ff6b6b;">0</div>
                <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unread-alerts" style="color: #ffc107;">0</div>
                <div class="stat-label">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="today-alerts" style="color: #28a745;">0</div>
                <div class="stat-label">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
        </div>

        <div class="alerts-container">
            <div class="alerts-header">
                <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
            </div>
            <div class="alerts-list" id="alerts-list">
                <div class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
        </div>

        <button class="btn btn-refresh" onclick="loadAlerts()">üîÑ</button>
    </div>

    <script>
        const ANIMAL_EMOJIS = {
            'person': 'üë§',
            'snake': 'üêç',
            'cat': 'üê±',
            'dog': 'üêï',
            'rat': 'üê≠',
            'lizard': 'ü¶é',
            'bird': 'ü¶Ö'
        };

        const THAI_ANIMAL_NAMES = {
            'person': '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•',
            'snake': '‡∏á‡∏π',
            'cat': '‡πÅ‡∏°‡∏ß',
            'dog': '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç',
            'rat': '‡∏´‡∏ô‡∏π',
            'lizard': '‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏Å',
            'bird': '‡∏ô‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà'
        };

        function formatTime(timestamp) {
            if (typeof timestamp === 'number') {
                return new Date(timestamp * 1000).toLocaleString('th-TH');
            }
            return new Date(timestamp).toLocaleString('th-TH');
        }

        function getAnimalEmoji(type) {
            return ANIMAL_EMOJIS[type] || '‚ùì';
        }

        function getThaiAnimalName(type) {
            return THAI_ANIMAL_NAMES[type] || type;
        }

        function isToday(dateString) {
            const today = new Date();
            const date = new Date(dateString);
            return date.toDateString() === today.toDateString();
        }

        function createAlertElement(alert) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item ${!alert.is_read ? 'unread' : ''}`;
            
            const emoji = getAnimalEmoji(alert.anomaly_type);
            const thaiName = getThaiAnimalName(alert.anomaly_type);
            const timeStr = formatTime(alert.timestamp || alert.created_at);
            
            alertDiv.innerHTML = `
                <div class="alert-header">
                    <div class="alert-type">
                        <span class="animal-emoji">${emoji}</span>
                        ${thaiName}
                    </div>
                    <div class="alert-confidence">
                        ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(alert.confidence * 100).toFixed(1)}%
                    </div>
                </div>
                <div class="alert-message">${alert.message}</div>
                <div class="alert-details">
                    <span>‚è∞ ${timeStr}</span>
                    <span>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: (${alert.location.x}, ${alert.location.y})</span>
                    <span>üîç ‡∏ß‡∏¥‡∏ò‡∏µ: ${alert.detection_method}</span>
                    ${alert.image_path ? `<span>üì∏ ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>` : ''}
                </div>
            `;

            if (!alert.is_read) {
                alertDiv.addEventListener('click', () => markAsRead(alert.id, alertDiv));
            }

            return alertDiv;
        }

        function markAsRead(alertId, element) {
            fetch(`/api/alerts/${alertId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    element.classList.remove('unread');
                    updateStats();
                }
            })
            .catch(error => {
                console.error('Error marking alert as read:', error);
            });
        }

        function updateStats() {
            const alertItems = document.querySelectorAll('.alert-item');
            const unreadItems = document.querySelectorAll('.alert-item.unread');
            
            // Count today's alerts
            let todayCount = 0;
            alertItems.forEach(item => {
                const timeText = item.querySelector('.alert-details span').textContent;
                const today = new Date().toDateString();
                if (timeText.includes(today.split(' ')[0])) {
                    todayCount++;
                }
            });

            document.getElementById('total-alerts').textContent = alertItems.length;
            document.getElementById('unread-alerts').textContent = unreadItems.length;
            document.getElementById('today-alerts').textContent = todayCount;
        }

        function loadAlerts() {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '<div class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            fetch('/api/alerts')
                .then(response => response.json())
                .then(data => {
                    alertsList.innerHTML = '';
                    
                    if (data.alerts && data.alerts.length > 0) {
                        data.alerts.forEach(alert => {
                            const alertElement = createAlertElement(alert);
                            alertsList.appendChild(alertElement);
                        });
                    } else {
                        alertsList.innerHTML = `
                            <div class="no-alerts">
                                <div>‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                                <div>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</div>
                            </div>
                        `;
                    }
                    
                    updateStats();
                })
                .catch(error => {
                    console.error('Error loading alerts:', error);
                    alertsList.innerHTML = `
                        <div class="no-alerts">
                            <div>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>
                            <div>${error.message}</div>
                        </div>
                    `;
                });
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        document.addEventListener('DOMContentLoaded', loadAlerts);

        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(loadAlerts, 30000);

        // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
        let lastAlertCount = 0;
        
        function checkForNewAlerts() {
            const currentCount = document.querySelectorAll('.alert-item').length;
            if (currentCount > lastAlertCount && lastAlertCount > 0) {
                // ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('üö® ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà!', {
                        body: '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°‡πÉ‡∏ô‡∏£‡∏±‡∏á‡∏ô‡∏Å‡∏ô‡∏≤‡∏á‡πÅ‡∏≠‡πà‡∏ô',
                        icon: '/static/icon.png'
                    });
                }
            }
            lastAlertCount = currentCount;
        }

        // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(checkForNewAlerts, 10000);
    </script>
</body>
</html>
